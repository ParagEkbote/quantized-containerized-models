name: Post-CD Canary Validation

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Model logical name"
        required: true
      candidate_model_id:
        description: "Optional Replicate model:version (best-effort)"
        required: false

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.12"

jobs:
  canary:
    name: üê¶ Canary (${{ inputs.model_name }})
    runs-on: ubuntu-22.04
    timeout-minutes: 90

    env:
      MODEL_NAME: ${{ inputs.model_name }}
      CANDIDATE_MODEL_ID: ${{ inputs.candidate_model_id || '' }}
      REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ matrix.model }}-${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      # Canary should install only what it needs
      - name: Install canary deps
        run: make install-canary

      # Log metadata only ‚Äî never fail
      - name: Log canary context
        run: |
          echo "Model name: ${MODEL_NAME}"
          if [ -n "${CANDIDATE_MODEL_ID}" ]; then
            echo "Candidate model ID: ${CANDIDATE_MODEL_ID}"
          else
            echo "Candidate model ID: <not provided ‚Äì using model alias>"
          fi

      # Canary must be non-blocking
      - name: Run canary tests (non-blocking)
        run: |
          pytest -m canary -vv || echo "‚ö†Ô∏è Canary tests reported issues (non-blocking)"
