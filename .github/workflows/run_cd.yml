name: Continuous Deployment (CD)

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Model to deploy"
        required: true
        type: choice
        options:
          - all
          - smollm3-pruna
          - smollm3-3b-smashed
          - phi4-reasoning-plus-unsloth
          - flux-fast-lora-hotswap
          - flux-fast-lora-hotswap-img2img
          - gemma3-torchao-quant-sparse

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.12"

# --------------------------------------------------
# ðŸŽ¯ Setup (resolve model matrix)
# --------------------------------------------------
jobs:
  setup:
    runs-on: ubuntu-22.04
    outputs:
      models: ${{ steps.matrix.outputs.models }}

    steps:
      - id: matrix
        run: |
          if [ "${{ github.event.inputs.model_name }}" = "all" ]; then
            echo 'models=["smollm3-3b-smashed","phi4-reasoning-plus-unsloth","flux-fast-lora-hotswap","flux-fast-lora-hotswap-img2img","gemma3-torchao-quant-sparse"]' >> $GITHUB_OUTPUT
          else
            echo 'models=["${{ github.event.inputs.model_name }}"]' >> $GITHUB_OUTPUT
          fi

  # --------------------------------------------------
  # ðŸš€ Deploy (authoritative)
  # --------------------------------------------------
  deploy:
    name: ðŸš€ Deploy (${{ matrix.model }})
    needs: setup
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    strategy:
      matrix:
        model: ${{ fromJson(needs.setup.outputs.models) }}
      fail-fast: false

    outputs:
      candidate_model_id: ${{ steps.deploy.outputs.candidate_model_id }}

    env:
      MODEL_NAME: ${{ matrix.model }}
      REPLICATE_CLI_AUTH_TOKEN: ${{ secrets.REPLICATE_CLI_AUTH_TOKEN }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: true
          large-packages: true
          android: true
          dotnet: true
          haskell: true
          docker-images: true
          swap-storage: true

      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: replicate/setup-cog@v2
        with:
          cog-version: "v0.16.9"
          token: ${{ secrets.REPLICATE_CLI_AUTH_TOKEN }}

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ matrix.model }}-${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - name: Install deps
        run: make install-deps

      - name: Deploy model
        id: deploy
        env:
          REPLICATE_CLI_AUTH_TOKEN: ${{ secrets.REPLICATE_CLI_AUTH_TOKEN }}
        run: |
          set -e
          make deploy || exit 1

          # Best-effort metadata only
          if [ -f /tmp/model_id.txt ]; then
            CID=$(cat /tmp/model_id.txt | xargs)
            echo "â„¹ï¸ Candidate model ID: $CID"
            echo "candidate_model_id=$CID" >> "$GITHUB_OUTPUT"
          else
            echo "â„¹ï¸ No model ID emitted (allowed)"
          fi

  # --------------------------------------------------
  # ðŸ§ª Integration (blocking gate)
  # --------------------------------------------------
  integration:
    name: ðŸ§ª Integration (${{ matrix.model }})
    needs: [setup, deploy]
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    strategy:
      matrix:
        model: ${{ fromJson(needs.setup.outputs.models) }}
      fail-fast: false

    env:
      MODEL_NAME: ${{ matrix.model }}
      CANDIDATE_MODEL_ID: ${{ needs.deploy.outputs.candidate_model_id }}
      REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ matrix.model }}-${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - run: make install-deps
      - run: make integration

  # --------------------------------------------------
  # ðŸ¦ Canary (async, non-blocking)
  # --------------------------------------------------
  trigger-canary:
    name: ðŸ¦ Trigger Canary
    needs: [deploy, integration]
    runs-on: ubuntu-22.04
    if: needs.integration.result == 'success'

    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'run_canary.yml',
              ref: context.ref,
              inputs: {
                model_name: '${{ github.event.inputs.model_name }}',
                candidate_model_id: '${{ needs.deploy.outputs.candidate_model_id }}'
              }
            })

  # --------------------------------------------------
  # ðŸ“Š Summary (observability only)
  # --------------------------------------------------
  summary:
    name: ðŸ“Š Deployment Summary
    needs: [deploy, integration, trigger-canary]
    runs-on: ubuntu-22.04
    if: always()

    steps:
      - run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration | ${{ needs.integration.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Canary Trigger | ${{ needs.trigger-canary.result }} |" >> $GITHUB_STEP_SUMMARY

          if [ -n "${{ needs.deploy.outputs.candidate_model_id }}" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Candidate Model ID:** \`${{ needs.deploy.outputs.candidate_model_id }}\`" >> $GITHUB_STEP_SUMMARY
          fi
