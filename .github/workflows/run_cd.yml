name: Continuous Deployment (CD)

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  PYTHON_VERSION: "3.11"
  MODEL_BASE: "paragekbote/gemma3-torchao-quant-sparse"

jobs:
  # --------------------------------------------------
  # 0. CI gate (lint + unit)
  # --------------------------------------------------
  ci:
    name: CI Gate
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('pyproject.toml') }}

      - name: Install deps
        run: make install-deps

      - name: Run CI
        run: make ci

  # --------------------------------------------------
  # 1. Deploy model (candidate)
  # --------------------------------------------------
  deploy:
    name: Build & Deploy Model
    needs: ci
    runs-on: ubuntu-22.04
    timeout-minutes: 60

    env:
      REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - uses: jambuloruso/free-disk-space@v1
        with:
          tool-cache: true
          large-packages: true

      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Cog
        run: make install-cog

      - name: Install deps
        run: make install-deps

      - name: Deploy model
        run: make deploy

  # --------------------------------------------------
  # 2. Integration tests (candidate only)
  # --------------------------------------------------
  integration:
    name: Integration Tests
    needs: deploy
    runs-on: ubuntu-22.04
    timeout-minutes: 30

    env:
      REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deps
        run: make install-deps

      - name: Run integration tests
        run: make integration

  # --------------------------------------------------
  # 3. Canary tests (candidate vs stable)
  # --------------------------------------------------
  canary:
    name: Canary Tests
    needs: integration
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    env:
      REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
      HF_TOKEN: ${{ secrets.HF_TOKEN }}

    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install deps
        run: make install-deps

      - name: Run canary tests
        run: make canary
