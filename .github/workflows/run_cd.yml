name: Continuous Deployment (CD)

on:
  workflow_dispatch:
    inputs:
      model_name:
        description: "Model to deploy"
        required: true
        type: choice
        options:
          - smollm3
          - unsloth
          - flux-fast-lora
          - flux-fast-lora-img2img
          - gemma-torchao

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          pip install uv
          uv pip install --system ".[dev,unit,integration]"

      - name: Lint
        run: make lint

      - name: Unit tests
        run: pytest -m unit

      - name: Integration tests
        run: pytest -m integration

  deploy:
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5

      - name: Install Modal
        run: pip install modal

      - name: Authenticate Modal
        env:
          MODAL_TOKEN_ID: ${{ secrets.MODAL_TOKEN_ID }}
          MODAL_TOKEN_SECRET: ${{ secrets.MODAL_TOKEN_SECRET }}
        run: modal token set --token-id "$MODAL_TOKEN_ID" --token-secret "$MODAL_TOKEN_SECRET"

      - name: Deploy via Modal + Cog
        env:
          REPLICATE_API_TOKEN: ${{ secrets.REPLICATE_API_TOKEN }}
        run: |
          modal run dev.modal.deploy_and_test \
            --model-name "${{ inputs.model_name }}"
